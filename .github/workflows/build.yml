name: Build and Release Tock UI



on:

  push:

    branches:

      - main

      - master

  pull_request:

    branches:

      - main

      - master

  workflow_dispatch:




permissions:

  contents: write

  issues: write

  pull-requests: write



jobs:

  prepare-version:

    runs-on: ubuntu-latest

    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    outputs:

      has_new_version: ${{ steps.version-check.outputs.has_new_version }}

      version: ${{ steps.version-check.outputs.version }}

      update_json_path: ${{ steps.version-check.outputs.update_json_path }}


    steps:

      - name: Checkout repository

        uses: actions/checkout@v4

        with:

          fetch-depth: 0


      - name: Setup Node.js

        uses: actions/setup-node@v4

        with:

          node-version: '22'

          cache: 'npm'

          cache-dependency-path: 'tock-ui/package-lock.json'


      - name: Install dependencies

        working-directory: ./tock-ui

        run: npm ci


      - name: Detect version and update files

        id: version-check

        env:

          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        run: node .github/scripts/prepare-version.js


      - name: Upload updated version files

        if: steps.version-check.outputs.has_new_version == 'true'

        uses: actions/upload-artifact@v4

        with:

          name: version-files

          path: |

            tock-ui/package.json

            tock-ui/src-tauri/Cargo.toml

            tock-ui/src-tauri/tauri.conf.json

          retention-days: 1

          include-hidden-files: false


      - name: Upload update JSON

        if: steps.version-check.outputs.has_new_version == 'true'

        uses: actions/upload-artifact@v4

        with:

          name: update-json

          path: tock-ui/dist/latest.json

          retention-days: 7



  build-and-release:

    needs: prepare-version

    if: |

      always() &&

      (needs.prepare-version.result == 'success' || needs.prepare-version.result == 'skipped') &&

      !cancelled()

    strategy:

      fail-fast: false

      matrix:

        include:

          - platform: 'ubuntu-22.04'

            args: ''

            artifact_name: 'linux'


            node_version: '20'  # Keep Node 20 for Tauri build

          - platform: 'windows-latest'

            args: ''

            artifact_name: 'windows'


            node_version: '20'  # Keep Node 20 for Tauri build



    runs-on: ${{ matrix.platform }}



    steps:

      - name: Checkout repository

        uses: actions/checkout@v4

        with:

          fetch-depth: 0

          ref: ${{ github.ref }}


      - name: Download updated version files

        if: needs.prepare-version.outputs.has_new_version == 'true'

        uses: actions/download-artifact@v4

        with:

          name: version-files

          path: .


      - name: Verify version files

        if: needs.prepare-version.outputs.has_new_version == 'true'

        run: |

          echo "Checking updated version files..."

          ls -la tock-ui/

          cat tock-ui/package.json | grep version

          cat tock-ui/src-tauri/Cargo.toml | grep "^version"

          cat tock-ui/src-tauri/tauri.conf.json | grep version




      - name: Setup Node.js for Tauri build

        uses: actions/setup-node@v4

        with:


          node-version: ${{ matrix.node_version }}

          cache: 'npm'

          cache-dependency-path: 'tock-ui/package-lock.json'



      - name: Install Rust stable

        uses: dtolnay/rust-toolchain@stable



      - name: Install Linux dependencies

        if: matrix.platform == 'ubuntu-22.04'

        run: |

          sudo apt-get update

          sudo apt-get install -y \

            libwebkit2gtk-4.1-dev \

            libappindicator3-dev \

            librsvg2-dev \

            patchelf \

            libssl-dev \

            libgtk-3-dev



      - name: Cache Rust dependencies

        uses: swatinem/rust-cache@v2

        with:

          workspaces: './tock-ui/src-tauri -> target'



      - name: Install frontend dependencies

        working-directory: ./tock-ui

        run: npm ci



      - name: Build Tauri application

        working-directory: ./tock-ui

        run: npm run tauri build -- ${{ matrix.args }}

        env:

          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}

          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}



      - name: Upload artifacts

        uses: actions/upload-artifact@v4

        with:

          name: ${{ matrix.artifact_name }}-artifacts

          path: |

            tock-ui/src-tauri/target/release/bundle/

          retention-days: 7



  semantic-release:

    needs: [prepare-version, build-and-release]

    runs-on: ubuntu-latest

    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && needs.prepare-version.outputs.has_new_version == 'true'



    steps:

      - name: Checkout repository

        uses: actions/checkout@v4

        with:

          fetch-depth: 0




      # âš¡ USE NODE 22 FOR SEMANTIC-RELEASE


      - name: Setup Node.js 22 for semantic-release

        uses: actions/setup-node@v4

        with:


          node-version: '22'


          cache: 'npm'


          cache-dependency-path: 'tock-ui/package-lock.json'



      - name: Install semantic-release dependencies

        working-directory: ./tock-ui

        run: |


          # Clean install with Node 22


          npm ci









      - name: Download updated version files

        uses: actions/download-artifact@v4

        with:

          name: version-files

          path: .


      - name: Verify version files for release

        run: |

          echo "Version files for semantic-release:"

          cat tock-ui/package.json | grep version

          cat tock-ui/src-tauri/Cargo.toml | grep "^version"

          cat tock-ui/src-tauri/tauri.conf.json | grep version


      - name: Download all build artifacts

        uses: actions/download-artifact@v4

        with:

          path: dist-artifacts


      - name: Download update JSON

        uses: actions/download-artifact@v4

        with:

          name: update-json

          path: update-json



      - name: Prepare artifacts for release

        run: |


          mkdir -p release-artifacts


          find dist-artifacts -type f \( -name "*.deb" -o -name "*.AppImage" -o -name "*.msi" -o -name "*.exe" \) \

            -exec cp {} release-artifacts/ \;

          

          # Copy update JSON to release artifacts

          cp update-json/latest.json release-artifacts/


          echo "Artifacts ready:"



          ls -la release-artifacts/



      - name: Semantic Release

        working-directory: ./tock-ui

        env:

          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        run: npx semantic-release
